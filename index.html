<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-olive:#556B2F;
      --brand-olive-light:#7B8A2F;
      --bg-cream:#f7efe0;
      --accent:#b3611f;
      --muted:#7c6a5c;
      --card-border:#6b7a29;
    }
    html,body{height:100%;}
    body {
      background: var(--bg-cream);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      margin:0;
      min-height:100vh;
      color:#2b2b2b;
    }
    .header {
      text-align:center;
      padding:28px 12px 10px 12px;
      background: linear-gradient(90deg, var(--brand-olive) 0%, var(--brand-olive-light) 100%);
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      position:relative;
    }
    .logo-wrap {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
    }
    @keyframes logoPop { from{transform:scale(0.7); opacity:0;} to{transform:scale(1); opacity:1;} }
    .logo-img {
      width:84px;
      height:84px;
      object-fit:cover;
      border-radius:50%;
      border: none;
      background: transparent;
      padding: 0;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      animation:logoPop .35s ease;
    }
    .header-title {
      font-size:2.0em;
      color:#fff;
      font-weight:800;
      letter-spacing:1px;
      text-shadow:0 1px 6px rgba(0,0,0,0.12);
      margin-bottom:0;
    }
    .header-desc {
      color:#fffbe6;
      font-size:1.02em;
      font-weight:700;
      letter-spacing:0.5px;
      margin-top:6px;
      opacity:0.95;
    }
    .promo-banner {
      text-align:center;
      margin-top:10px;
      margin-bottom:10px;
      letter-spacing:1px;
    }
    .promo-star { color:var(--accent); font-size:1.6em; vertical-align:middle; }
    .promo-text { color:#fffbe6; font-weight:700; margin:0 8px; }

    /* loader overlay */
    #menuLoader{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.9); z-index:300; pointer-events:none; opacity:0; transition:opacity .18s;
      backdrop-filter: blur(3px);
      flex-direction:column; gap:12px;
    }
    #menuLoader.visible{ opacity:1; pointer-events:auto; }
    .spinner{ width:64px; height:64px; border:6px solid rgba(0,0,0,0.06); border-top-color:var(--brand-olive); border-radius:50%; animation:spin 0.9s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .loader-text{ color:var(--brand-olive); font-weight:800; }

    /* GRID-based menu */
    .menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:18px;
      justify-items:center;
      max-width:1100px;
      margin:26px auto 80px;
      padding:0 12px;
      box-sizing:border-box;
    }

    .product {
      background: #fff;
      border-radius:14px;
      box-shadow:0 4px 18px rgba(0,0,0,0.06);
      width:200px;
      padding:16px 12px 14px;
      display:flex; flex-direction:column; align-items:center;
      transition:transform .18s,box-shadow .18s;
      position:relative;
      border:2px solid var(--card-border);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      box-sizing:border-box;
    }
    .product:not(.unavailable):hover {
      transform:translateY(-6px) scale(1.02);
      box-shadow:0 10px 28px rgba(0,0,0,0.08);
      border-color:var(--brand-olive-light);
    }
    .product.unavailable { opacity:.6; pointer-events:none; }
    .product-img {
      width:100px; height:100px; object-fit:cover; border-radius:12px; margin-bottom:10px; background:#eee;
      border:2px solid var(--brand-olive);
    }
    .product-name {
      font-size:1.05em; font-weight:700; color:var(--brand-olive); margin-bottom:6px; text-align:center;
      letter-spacing:1px; text-transform:uppercase;
    }
    .product-desc {
      color:var(--muted); font-size:.95em; margin-bottom:6px; text-align:center; min-height:36px;
    }
    .product-price {
      font-size:1.05em; color:#222; margin-bottom:10px; font-weight:700; letter-spacing:0.5px;
    }
    .controls { display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }
    .add-btn, .remove-btn {
      border:none; border-radius:8px; font-size:1em; padding:6px 12px; margin:0 4px; cursor:pointer; transition:filter .12s;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      font-weight:700;
    }
    .add-btn { background:var(--brand-olive); color:#fff; box-shadow:0 2px 6px rgba(91,104,44,0.12); }
    .remove-btn { background:#fff; color:var(--brand-olive); border:1px solid var(--card-border); }
    .add-btn:active,.remove-btn:active{ transform:translateY(1px); }

    .cart-fab {
      position:fixed; bottom:22px; right:18px; background:none; border:none; box-shadow:none;
      width:72px; height:72px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:100; padding:0;
      transition:transform .18s;
    }
    .cart-fab svg { display:block; filter: drop-shadow(0 4px 18px rgba(0,0,0,0.12));}
    .cart-fab-circle { fill:var(--accent); stroke:#fff; stroke-width:2; }
    .cart-fab-count {
      position:absolute; right:6px; top:6px; background:#fff; color:var(--accent); font-weight:700;
      border-radius:50%; min-width:26px; height:26px; display:flex; align-items:center; justify-content:center;
      font-size:1em; box-shadow:0 2px 8px rgba(0,0,0,0.12); border:2px solid var(--accent);
      pointer-events:none;
    }

    .cart-modal-bg {
      position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:200;
      display:flex; align-items:flex-start; justify-content:center; animation:fadein .22s;
    }
    @keyframes fadein { from{opacity:0;} to{opacity:1;} }
    .cart-modal {
      background: var(--bg-cream); border-radius:18px; padding:20px 16px 16px 16px; min-width:320px; max-width:95vw;
      box-shadow:0 12px 36px rgba(0,0,0,0.12); position:relative;
      border:2px solid var(--brand-olive);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      max-height:86vh; overflow-y:auto;
      display:flex; flex-direction:column;
      margin-top:36px;
    }
    .cart-title { font-size:1.2em; color:var(--brand-olive); margin-bottom:10px; letter-spacing:1px; font-weight:800; }
    .cart-list { list-style:none; padding:0; margin:0 0 10px 0; }
    .cart-list li { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:#333; }
    .cart-total { font-size:1.05em; color:#222; margin-bottom:12px; text-align:right; font-weight:800; }
    .cart-close { position:absolute; right:10px; top:8px; font-size:1.4em; color:var(--brand-olive); background:none; border:none; cursor:pointer; }
    .order-form input, .order-form textarea, .order-form select {
      width:100%; padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; font-size:1em;
      background:#fff; font-family: 'PT Sans Narrow', Arial, sans-serif;
    }
    .order-btn {
      background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 18px; font-size:1.03em; font-weight:800; cursor:pointer; width:100%; margin-top:8px;
      letter-spacing:1px;
    }
    .order-success { color:#2e7d32; font-size:1.05em; text-align:center; margin-top:10px; }

    .order-success-overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.96); z-index:400; opacity:0; transform:scale(.98);
      transition:opacity .22s ease, transform .22s ease;
      pointer-events:none;
      flex-direction:column; gap:12px;
      border-radius:14px;
    }
    .order-success-overlay.visible { opacity:1; transform:scale(1); pointer-events:auto; }
    .success-logo { width:60px; height:60px; border-radius:50%; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,0.12); transform:scale(.9); animation:logoPop .36s ease forwards; }
    .check-svg { width:120px; height:120px; display:block; }
    .check-svg .circle { fill:none; stroke:var(--brand-olive); stroke-width:6; stroke-linecap:round; stroke-dasharray: 330; stroke-dashoffset:330; animation:drawCircle .6s ease forwards; }
    .check-svg .check { fill:none; stroke:var(--accent); stroke-width:8; stroke-linecap:round; stroke-linejoin:round; stroke-dasharray:120; stroke-dashoffset:120; animation:drawCheck .45s ease .5s forwards; }
    @keyframes drawCircle { to{ stroke-dashoffset:0; } }
    @keyframes drawCheck { to{ stroke-dashoffset:0; } }

    .unavailable-label { display:none; }

    .product .prod-unavailable {
      position: absolute;
      left: 8px;
      right: 8px;
      top: 8px;
      background: var(--accent);
      color: #fff;
      font-size: .95em;
      border-radius: 10px;
      padding: 6px 8px;
      text-align: center;
      letter-spacing: 1px;
      z-index: 6;
      pointer-events: none;
    }

    @media (max-width:1000px) {
      .menu { grid-template-columns: repeat(3, minmax(140px, 1fr)); max-width:900px; }
    }
    @media (max-width:600px) {
      .menu { grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:12px; max-width:720px; margin-bottom:120px; }
      .product { width:100%; max-width:220px; padding:10px 8px; }
      .product-img { width:72px; height:72px; }
      .cart-modal { min-width:92vw; padding:12px 8px 10px 8px; border-radius:16px; margin-top:12vw;}
      .cart-fab { width:56px; height:56px; bottom:12px; right:10px; top:auto !important;}
      .cart-fab-count { min-width:18px; height:18px; font-size:.9em; right:2px; top:2px; }
      .header-title { font-size:1.4em; }
      .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:6px; }
    }
    @media (max-width:420px) {
      .menu { gap:10px; padding:0 8px; }
      .header-title { font-size:1.1rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-wrap">
      <img class="logo-img" src="logo.png" alt="–°–í–û–Ø –ö–£–•–ù–Ø">
      <div>
        <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
        <div class="header-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã ‚Äî –≤–∫—É—Å–Ω–æ, –±—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º</div>
      </div>
    </div>
    <div class="promo-banner">
      <span class="promo-star">‚òÖ</span>
      <span class="promo-text">–ú–ï–ù–Æ</span>
      <span class="promo-star">‚òÖ</span>
    </div>
  </div>

  <!-- loader -->
  <div id="menuLoader" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é‚Ä¶</div>
  </div>

  <div class="menu" id="menu"></div>

  <button id="cartFab" class="cart-fab" style="display:none;" title="–ö–æ—Ä–∑–∏–Ω–∞" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
    <svg viewBox="0 0 48 48" width="56" height="56" style="display:block;margin:auto;">
      <circle cx="24" cy="24" r="22" class="cart-fab-circle"/>
      <path d="M16 18h16l-2 13a3 3 0 0 1-3 2h-6a3 3 0 0 1-3-2l-2-13zm3 0v-4a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v4" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
      <circle cx="19" cy="36" r="2" fill="#fff"/>
      <circle cx="29" cy="36" r="2" fill="#fff"/>
    </svg>
    <span id="cartFabCount" class="cart-fab-count" aria-hidden="true"></span>
  </button>

  <div id="cartModalBg" class="cart-modal-bg" style="display:none;"></div>

  <script>
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è) ---
    const SHEET_API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';
    const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';
    // Telegram bot token / admin chat id
    const TELEGRAM_BOT_TOKEN = '8543195311:AAGzpZwTaUAgw3qp6AeKQA_BbFX35jtbJIk';
    const TELEGRAM_CHAT_ID = '7567253745';

    // control orders window (accepting orders between times) ‚Äî set in 24h HH:MM
    // example: acceptFrom = "09:00", acceptTo = "21:00"
    const ORDER_ACCEPT_FROM = "09:00";
    const ORDER_ACCEPT_TO   = "21:00";

    let menuData = [];
    let cart = {};

    const VND_FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    // --- utils ---
    function showLoader(){ const l=document.getElementById('menuLoader'); if(!l) return; l.classList.add('visible'); l.setAttribute('aria-hidden','false'); }
    function hideLoader(){ const l=document.getElementById('menuLoader'); if(!l) return; l.classList.remove('visible'); l.setAttribute('aria-hidden','true'); }

    function toNumberSafe(v) {
      if (typeof v === 'number') return v;
      if (v == null) return 0;
      let s = String(v).replace(/\u00A0/g, '').trim();
      s = s.replace(/[^\d,.\-]/g, '');
      if (!s) return 0;
      s = s.replace(/,/g, '.');
      const parts = s.split('.');
      if (parts.length > 2) {
        const frac = parts.pop();
        s = parts.join('') + '.' + frac;
      }
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    async function attemptFetch(url, opts = {}, retries = 2, backoff = 300) {
      try {
        const res = await fetch(url, opts);
        if (!res.ok) throw res;
        return res;
      } catch (err) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, backoff));
          return attemptFetch(url, opts, retries - 1, backoff * 2);
        }
        throw err;
      }
    }

    function timeToMinutes(t){ const [h,m]=String(t||'00:00').split(':').map(Number); return (h||0)*60 + (m||0); }
    function nowAccepting(){
      const now = new Date();
      const mins = now.getHours()*60 + now.getMinutes();
      const from = timeToMinutes(ORDER_ACCEPT_FROM);
      const to = timeToMinutes(ORDER_ACCEPT_TO);
      if (from <= to) return mins >= from && mins <= to;
      // overnight window
      return mins >= from || mins <= to;
    }

    // parse menu item (garnish options, isHot)
    function makeMenuItem(obj, idx){
      const get = key => (obj && (obj[key] !== undefined ? obj[key] : '')) || '';
      const name = get('name') || get('title') || `–ë–ª—é–¥–æ ${idx+1}`;
      const description = get('description') || get('desc') || '';
      const img = get('img') || get('image') || '';
      const price = toNumberSafe(get('price') || get('cost') || get('—Ü–µ–Ω–∞'));
      const available = String(get('available') || get('–¥–æ—Å—Ç—É–ø–Ω–æ') || 'true').trim().toLowerCase() === 'true';
      const rawG = get('garnish') || get('garnishes') || get('–≥–∞—Ä–Ω–∏—Ä') || '';
      const garnishOptions = String(rawG).split(/[|,;]+/).map(s=>s.trim()).filter(Boolean);
      const hotFlag = String(get('hot') || get('–≥–æ—Ä—è—á–µ–µ') || get('category') || '').trim().toLowerCase();
      const isHot = hotFlag === 'true' || /–≥–æ—Ä—è—á|hot/i.test(name + ' ' + (get('category')||''));
      return { id: idx+1, name, description, img, price, available, garnishOptions, isHot };
    }

    async function loadMenu(){
      showLoader();
      try {
        const res = await attemptFetch(SHEET_API_URL, {}, 2);
        const json = await res.json();
        if (json && Array.isArray(json.values) && json.values.length>0){
          const rows = json.values;
          const headers = rows[0].map(h=>String(h||'').trim().toLowerCase());
          const dataRows = rows.slice(1);
          menuData = dataRows.map((row,idx)=>{
            const obj = {};
            headers.forEach((h,i)=> obj[h] = row[i] !== undefined ? row[i] : '');
            return makeMenuItem(obj, idx);
          });
          renderMenu();
          hideLoader();
          return;
        }
        if (json && json.menu && Array.isArray(json.menu)){
          menuData = json.menu.map((it,idx)=>makeMenuItem(it, idx));
          renderMenu(); hideLoader(); return;
        }
        if (Array.isArray(json) && json.length>0 && typeof json[0] === 'object'){
          menuData = json.map((it,idx)=>makeMenuItem(it, idx));
          renderMenu(); hideLoader(); return;
        }
        throw new Error('Unknown format');
      } catch (err) {
        console.warn('Primary fetch failed:', err);
        try {
          const res2 = await attemptFetch(SHEET_API_FALLBACK, {}, 1);
          const j2 = await res2.json();
          if (j2 && j2.menu && Array.isArray(j2.menu)){ menuData = j2.menu.map((it,idx)=>makeMenuItem(it, idx)); renderMenu(); hideLoader(); return; }
        } catch(e2){ console.warn('Fallback failed', e2); }
        hideLoader();
        document.getElementById('menu').innerHTML = '<div style="color:var(--brand-olive);font-size:1.05em;text-align:center;margin:40px auto;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SHEET_API_URL / API_KEY / CORS.</div>';
      }
    }

    function renderMenu(){
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      if (!menuData || menuData.length===0){
        menu.innerHTML = '<div style="color:var(--brand-olive);font-size:1.05em;text-align:center;margin:40px auto;">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</div>';
        updateCartFab(); return;
      }
      menuData.forEach(item=>{
        const prod = document.createElement('div');
        prod.className = 'product' + (!item.available ? ' unavailable' : '');
        const priceText = VND_FMT.format(Number(item.price) || 0);
        const garnishNote = (item.isHot && item.garnishOptions && item.garnishOptions.length) ? `<div style="font-size:0.85em;color:#7c6a5c;margin-bottom:6px;">–ì–æ—Ä—è—á–µ–µ ‚Äî –≥–∞—Ä–Ω–∏—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ</div>` : (item.isHot ? `<div style="font-size:0.85em;color:#7c6a5c;margin-bottom:6px;">–ì–æ—Ä—è—á–µ–µ –±–ª—é–¥–æ</div>` : '');
        prod.innerHTML = `
          ${!item.available ? `<div class="prod-unavailable">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>` : ''}
          <img class="product-img" src="${item.img || 'https://via.placeholder.com/100x100?text=–§–æ—Ç–æ'}" alt="${escapeHtml(item.name)}">
          <div class="product-name">${escapeHtml(item.name)}</div>
          <div class="product-desc">${escapeHtml(item.description || '')}</div>
          ${garnishNote}
          <div class="product-price">${priceText}</div>
          <div class="controls">
            <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
            <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
            <button class="add-btn" ${!item.available || !nowAccepting() ? 'disabled' : ''} onclick="updateCart(${item.id},1)">${nowAccepting() ? '+' : '–ó–∞–∫—Ä—ã—Ç'}</button>
          </div>
        `;
        menu.appendChild(prod);
      });
      updateCartFab();
    }

    window.updateCart = function(id, delta){
      const item = menuData.find(i=>i.id===id);
      if (!item || !item.available) return;
      if (!nowAccepting() && delta>0) { alert('–ü—Ä–∏—ë–º –∑–∞—è–≤–æ–∫ —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç.'); return; }
      if (!cart[id]) cart[id] = { ...item, qty:0, garnish: (item.garnishOptions && item.garnishOptions[0]) || '' };
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      const qtyEl = document.getElementById(`qty-${id}`);
      if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
      updateCartFab();
      if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
    };

    // set garnish from select in modal
    window.setGarnish = function(id,val){
      if (!cart[id]) return;
      cart[id].garnish = String(val||'').trim();
    };

    function updateCartFab(){
      const fab = document.getElementById('cartFab');
      const count = Object.values(cart).reduce((s,i)=>s + (i.qty||0), 0);
      if (count>0){ fab.style.display='flex'; document.getElementById('cartFabCount').textContent = count; }
      else { fab.style.display='none'; document.getElementById('cartFabCount').textContent = ''; }
    }

    document.getElementById('cartFab').onclick = showCartModal;

    function showCartModal(){
      const modalBg = document.getElementById('cartModalBg');
      const items = Object.values(cart);
      const listHtml = items.length === 0 ? '<li style="color:var(--brand-olive);text-align:center;width:100%;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</li>' :
        items.map(it=>{
          const garnishControl = (it.garnishOptions && it.garnishOptions.length) ? `
            <div style="margin-top:6px;">
              <label style="font-size:0.9em;color:#7c6a5c;">–ì–∞—Ä–Ω–∏—Ä:
                <select onchange="setGarnish(${it.id}, this.value)">
                  ${it.garnishOptions.map(opt=>`<option value="${escapeHtml(opt)}" ${String(it.garnish||'')===opt ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
                </select>
              </label>
            </div>` : '';
          return `
            <li style="flex-direction:column;align-items:flex-start;">
              <div style="width:100%;display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:700;">${escapeHtml(it.name)} x${it.qty}</span>
                <span>
                  <button class="remove-btn" onclick="updateCart(${it.id},-1)">‚àí</button>
                  <span style="margin:0 8px;">${VND_FMT.format((it.price||0) * it.qty)}</span>
                  <button class="add-btn" onclick="updateCart(${it.id},1)">+</button>
                </span>
              </div>
              ${garnishControl}
            </li>`;
        }).join('');
      const total = items.reduce((s,i)=>s + (i.price||0) * i.qty, 0);
      modalBg.innerHTML = `
        <div class="cart-modal" role="dialog" aria-modal="true" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
          <button class="cart-close" onclick="closeCartModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="position:absolute;right:10px;top:6px;border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
          <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <ul class="cart-list">${listHtml}</ul>
          <div class="cart-total">–ò—Ç–æ–≥–æ: ${VND_FMT.format(total)}</div>
          <form class="order-form" id="orderForm">
            <input type="text" id="name"
                   placeholder="–ù–∏–∫–Ω–µ–π–º —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞ (–ø—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º)"
                   aria-label="–ù–∏–∫–Ω–µ–π–º —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞ (–ø—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º)"
                   title="–ü—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º"
                   required>
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
            <label style="display:block;margin-bottom:8px;font-size:0.95em;color:#7c6a5c;">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–æ–≤—ã—Ö –ø—Ä–∏–±–æ—Ä–æ–≤:
              <input type="number" id="utensils" min="0" value="0" style="width:80px;margin-left:8px;">
            </label>
            <select id="payment">
              <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
              <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
              <option value="qr">QR (–æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫–∞–Ω)</option>
            </select>
            <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            <button type="submit" class="order-btn" ${nowAccepting() ? '' : 'disabled'}>${nowAccepting() ? '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑' : '–ü—Ä–∏—ë–º –∑–∞–∫—Ä—ã—Ç'}</button>
            <div id="orderSuccess" class="order-success" style="display:none;"></div>
          </form>
        </div>
      `;
      modalBg.style.display = 'flex';
      const orderForm = document.getElementById('orderForm');
      if (orderForm) orderForm.onsubmit = sendOrder;
      setTimeout(()=>{ const modal = document.querySelector('.cart-modal'); if (modal) modal.scrollIntoView({behavior:"smooth", block:"start"}); }, 50);
    }

    window.closeCartModal = function(){ document.getElementById('cartModalBg').style.display = 'none'; };

    // success animation overlay
    function showOrderSuccessAnimation(message){
      const modal = document.querySelector('.cart-modal');
      if (!modal) return;
      const prev = modal.querySelector('.order-success-overlay');
      if (prev) prev.remove();
      const overlay = document.createElement('div');
      overlay.className = 'order-success-overlay';
      overlay.innerHTML = `
        <img src="logo.png" alt="logo" class="success-logo" />
        <svg class="check-svg" viewBox="0 0 120 120" aria-hidden="true">
          <circle class="circle" cx="60" cy="60" r="52"></circle>
          <path class="check" d="M34 63l18 16 34-38"></path>
        </svg>
        <div class="success-text">${escapeHtml(message || '–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç.')}</div>
      `;
      modal.appendChild(overlay);
      setTimeout(()=> overlay.classList.add('visible'), 10);
      setTimeout(()=>{ overlay.classList.remove('visible'); setTimeout(()=>{ overlay.remove(); closeCartModal(); renderMenu(); }, 240); }, 1700);
    }

    // send order ‚Äî sends Telegram message to admin with inline buttons (Accept/Reject) and posts to fallback endpoint
    async function sendOrder(e){
      e.preventDefault();
      if (!nowAccepting()){ alert('–ü—Ä–∏—ë–º –∑–∞—è–≤–æ–∫ —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç.'); return; }
      const btn = document.querySelector('.order-btn');
      btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.getElementById('payment').value;
      const comment = document.getElementById('comment').value.trim();
      const utensils = Number(document.getElementById('utensils').value) || 0;
      if (!name || !phone || !address){ alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!'); btn.disabled=false; btn.textContent='–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
      const itemsArr = Object.values(cart);
      if (itemsArr.length === 0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); btn.disabled=false; btn.textContent='–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
      const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty, 0);
      const orderId = 'ORD-' + Date.now(); // simple id
      // prepare lines including garnish
      const orderLines = itemsArr.map(i=>`${i.name}${i.garnish ? ' ('+i.garnish+')' : ''} x${i.qty} ‚Äî ${VND_FMT.format(i.price * i.qty)}`).join('\n');
      const paymentText = payment === 'cash' ? '–û–ø–ª–∞—Ç–∞: –ù–∞–ª–∏—á–Ω—ã–µ' : payment === 'qr' ? '–û–ø–ª–∞—Ç–∞: QR' : '';
      const utensilsText = utensils > 0 ? `–°—Ç–æ–ª–æ–≤—ã–µ –ø—Ä–∏–±–æ—Ä—ã: ${utensils}\n` : '';
      const text =
        `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (${orderId}) ‚Äî –°–í–û–Ø –ö–£–•–ù–Ø\n` +
        `–ù–∏–∫/–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n` +
        utensilsText +
        (paymentText ? paymentText + '\n' : '') +
        (comment ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n` : '') +
        `\n–ó–∞–∫–∞–∑:\n${orderLines}\n\n–°—É–º–º–∞: ${VND_FMT.format(total)}`;

      // Inline keyboard with admin action links.
      // NOTE: callback handling must be implemented server-side (e.g. Apps Script) at SHEET_API_FALLBACK
      const acceptUrl = `${SHEET_API_FALLBACK}?action=accept&orderId=${encodeURIComponent(orderId)}`;
      const rejectUrl = `${SHEET_API_FALLBACK}?action=reject&orderId=${encodeURIComponent(orderId)}`;

      try {
        // 1) send to Telegram admin with inline buttons (URLs). Admin can click to open server page that performs accept/reject.
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text,
            reply_markup: {
              inline_keyboard: [
                [{ text: '–ü—Ä–∏–Ω—è—Ç—å ‚úÖ', url: acceptUrl }, { text: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å ‚ùå', url: rejectUrl }]
              ]
            }
          })
        });

        // 2) POST order to fallback server (if implemented) so it can store order and notify client later.
        //    The server should accept this JSON and implement endpoints for ?action=accept|reject that send notifications to client.
        try {
          await fetch(SHEET_API_FALLBACK, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'newOrder',
              orderId,
              name, phone, address, payment, comment, utensils, total,
              items: itemsArr.map(i=>({ id:i.id, name:i.name, qty:i.qty, price:i.price, garnish:i.garnish })),
              telegramNick: name // attempt to notify by nick if server supports
            })
          });
        } catch(postErr){
          // non-fatal ‚Äî server fallback may be absent
          console.warn('Posting order to fallback failed', postErr);
        }

        // client feedback
        cart = {};
        updateCartFab();
        showOrderSuccessAnimation('–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É.');
        btn.style.display = 'none';
        return;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        console.error('sendOrder error', err);
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      }
    }

    // --- init ---
    loadMenu();
  </script>
</body>
</html>
