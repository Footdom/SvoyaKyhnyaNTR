<script>
  // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
  const SHEET_API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';
  const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

  // –ù–ï —Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –∫–ª–∏–µ–Ω—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ Apps Script / —Å–µ—Ä–≤–µ—Ä
  const TELEGRAM_BOT_TOKEN = '8543195311:AAGzpZwTaUAgw3qp6AeKQA_BbFX35jtbJIk';
  const TELEGRAM_CHAT_ID = '7567253745';

  let menuData = [];
  let cart = {};

  const VND_FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

  function toNumberSafe(v) {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    let s = String(v).replace(/\u00A0/g, '').trim();
    s = s.replace(/[^\d,.\-]/g, '');
    if (!s) return 0;
    s = s.replace(/,/g, '.');
    const parts = s.split('.');
    if (parts.length > 2) {
      const frac = parts.pop();
      s = parts.join('') + '.' + frac;
    }
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

  async function attemptFetch(url, opts = {}, retries = 2, backoff = 400) {
    try {
      const res = await fetch(url, opts);
      if (!res.ok) throw res;
      return res;
    } catch (err) {
      if (retries > 0) {
        await new Promise(r => setTimeout(r, backoff));
        return attemptFetch(url, opts, retries - 1, backoff * 2);
      }
      throw err;
    }
  }

  function showMenuError(message) {
    const menu = document.getElementById('menu');
    menu.innerHTML = `<div style="color:var(--brand-olive);font-size:1.05em;text-align:center;margin:40px auto;line-height:1.4;">
      ${escapeHtml(message)}
      <div style="font-size:0.9em;margin-top:8px;color:#7c6a5c;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ SHEET API URL / API_KEY, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ CORS (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Google Sheets API ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω–∞ –∏–ª–∏ –≤—ã–¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å).</div>
    </div>`;
  }

  function makeMenuItem(obj, idx) {
    const get = key => (obj && (obj[key] !== undefined ? obj[key] : '')) || '';
    const name = get('name') || get('title') || `–ë–ª—é–¥–æ ${idx+1}`;
    const description = get('description') || get('desc') || '';
    const img = get('img') || get('image') || '';
    const price = toNumberSafe(get('price') || get('cost') || get('—Ü–µ–Ω–∞'));
    // -- –ì–ª–∞–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ! --
    const availableRaw = String(get('available') || get('–¥–æ—Å—Ç—É–ø–Ω–æ') || 'true').trim().toLowerCase();
    const available = !['false', '–Ω–µ—Ç', '0', 'no', '–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'].includes(availableRaw);
    // --------------------------
    const rawG = get('garnish') || get('garnishes') || get('–≥–∞—Ä–Ω–∏—Ä') || '';
    const garnishOptions = String(rawG).split(/[|,;]+/).map(s=>s.trim()).filter(Boolean);
    const hotFlag = String(get('hot') || get('–≥–æ—Ä—è—á–µ–µ') || get('category') || '').trim().toLowerCase();
    const isHot = hotFlag === 'true' || /–≥–æ—Ä—è—á|hot/i.test(name + ' ' + (get('category')||''));
    return { id: idx+1, name, description, img, price, available, garnishOptions, isHot };
  }

  async function loadMenu() {
    const tryLoad = async (url) => {
      const res = await attemptFetch(url, {}, 2);
      return res.json();
    };

    try {
      const json = await tryLoad(SHEET_API_URL);
      if (json && Array.isArray(json.values) && json.values.length > 0) {
        const rows = json.values;
        const headers = rows[0].map(h => String(h || '').trim().toLowerCase());
        const dataRows = rows.slice(1);
        menuData = dataRows.map((row, idx) => {
          const obj = {};
          headers.forEach((h, i) => obj[h] = row[i] !== undefined ? row[i] : '');
          return makeMenuItem(obj, idx);
        });
        renderMenu();
        return;
      }
      if (json && json.menu && Array.isArray(json.menu)) {
        menuData = json.menu.map((item, idx) => makeMenuItem(item, idx));
        renderMenu();
        return;
      }
      if (Array.isArray(json) && json.length > 0 && typeof json[0] === 'object') {
        menuData = json.map((item, idx) => makeMenuItem(item, idx));
        renderMenu();
        return;
      }
      throw new Error('Unknown sheet response format');
    } catch (err) {
      console.warn('Load menu failed:', err);
      try {
        const json2 = await tryLoad(SHEET_API_FALLBACK);
        if (json2 && json2.menu && Array.isArray(json2.menu)) {
          menuData = json2.menu.map((item, idx) => makeMenuItem(item, idx));
          renderMenu();
          return;
        }
      } catch (e2) {
        console.warn('Fallback failed:', e2);
      }
      const msg = (err && err.status === 403)
        ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets API (403). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_KEY –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ç–∞–±–ª–∏—Ü—ã.'
        : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ SHEET API URL, API_KEY –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞.';
      showMenuError(msg);
    }
  }

  function renderMenu() {
    const menu = document.getElementById('menu');
    menu.innerHTML = '';
    if (!menuData || menuData.length === 0) {
      menu.innerHTML = '<div style="color:var(--brand-olive);font-size:1.05em;text-align:center;margin:40px auto;">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</div>';
      updateCartFab();
      return;
    }
    menuData.forEach(item => {
      const prod = document.createElement('div');
      prod.className = 'product' + (!item.available ? ' unavailable' : '');
      const priceText = VND_FMT.format(Number(item.price) || 0);
      const garnishNote = (item.isHot || (item.garnishOptions && item.garnishOptions.length))
        ? `<div style="font-size:0.85em;color:#7c6a5c;margin-bottom:6px;">${item.isHot ? '–ì–æ—Ä—è—á–µ–µ –±–ª—é–¥–æ. ' : ''}${item.garnishOptions && item.garnishOptions.length ? '–í–æ–∑–º–æ–∂–µ–Ω –≥–∞—Ä–Ω–∏—Ä' : ''}</div>`
        : '';
      prod.innerHTML = `
        ${!item.available ? `<div class="prod-unavailable">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>` : ''}
        <img class="product-img" src="${item.img || 'https://via.placeholder.com/100x100?text=–§–æ—Ç–æ'}" alt="${escapeHtml(item.name)}">
        <div class="product-name">${escapeHtml(item.name)}</div>
        <div class="product-desc">${escapeHtml(item.description || '')}</div>
        ${garnishNote}
        <div class="product-price">${priceText}</div>
        <div class="controls">
          <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
          <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
          <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
        </div>
      `;
      menu.appendChild(prod);
    });
    updateCartFab();
  }

  window.updateCart = function(id, delta) {
    const item = menuData.find(i=>i.id===id);
    if (!item || !item.available) return;
    if (!cart[id]) cart[id] = { ...item, qty: 0, garnish: (item.garnishOptions && item.garnishOptions[0]) || '' };
    cart[id].qty = Math.max(0, cart[id].qty + delta);
    if (cart[id].qty === 0) delete cart[id];
    const qtyEl = document.getElementById(`qty-${id}`);
    if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
    updateCartFab();
    if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
  };

  window.setGarnish = function(id, val) {
    if (!cart[id]) return;
    cart[id].garnish = String(val || '').trim();
  };

  function updateCartFab() {
    const fab = document.getElementById('cartFab');
    const count = Object.values(cart).reduce((s,i)=>s + (i.qty || 0), 0);
    if (count > 0) {
      fab.style.display = 'flex';
      document.getElementById('cartFabCount').textContent = count;
    } else {
      fab.style.display = 'none';
      document.getElementById('cartFabCount').textContent = '';
    }
  }

  document.getElementById('cartFab').onclick = showCartModal;

  function showCartModal() {
    const modalBg = document.getElementById('cartModalBg');
    const items = Object.values(cart);
    const listHtml = items.length === 0
      ? '<li style="color:var(--brand-olive);text-align:center;width:100%;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</li>'
      : items.map(it => {
          const garnishControl = (it.garnishOptions && it.garnishOptions.length)
            ? `<div style="margin-top:6px;">
                 <label style="font-size:0.9em;color:#7c6a5c;">–ì–∞—Ä–Ω–∏—Ä:
                   <select onchange="setGarnish(${it.id}, this.value)">
                     ${it.garnishOptions.map(opt => `<option value="${escapeHtml(opt)}" ${String(it.garnish||'')===opt ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
                   </select>
                 </label>
               </div>`
            : '';
          return `
          <li style="flex-direction:column;align-items:flex-start;">
            <div style="width:100%;display:flex;justify-content:space-between;align-items:center;">
              <span style="font-weight:700;">${escapeHtml(it.name)} x${it.qty}</span>
              <span>
                <button class="remove-btn" onclick="updateCart(${it.id},-1)">‚àí</button>
                <span style="margin:0 8px;">${VND_FMT.format((it.price||0) * it.qty)}</span>
                <button class="add-btn" onclick="updateCart(${it.id},1)">+</button>
              </span>
            </div>
            ${garnishControl}
          </li>`;
        }).join('');
    const total = items.reduce((s,i)=>s + (i.price || 0) * i.qty, 0);
    modalBg.innerHTML = `
      <div class="cart-modal" role="dialog" aria-modal="true" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
        <button class="cart-close" onclick="closeCartModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="position:absolute;right:10px;top:6px;border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
        <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <ul class="cart-list">${listHtml}</ul>
        <div class="cart-total">–ò—Ç–æ–≥–æ: ${VND_FMT.format(total)}</div>
        <form class="order-form" id="orderForm">
          <input type="text" id="name"
                 placeholder="–ù–∏–∫–Ω–µ–π–º —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞ (–ø—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º)"
                 aria-label="–ù–∏–∫–Ω–µ–π–º —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞ (–ø—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º)"
                 title="–ü—Ä–æ—Å—å–±–∞ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º"
                 required>
          <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
          <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
          <label style="display:block;margin-bottom:8px;font-size:0.95em;color:#7c6a5c;">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–æ–≤—ã—Ö –ø—Ä–∏–±–æ—Ä–æ–≤:
            <input type="number" id="utensils" min="0" value="0" style="width:80px;margin-left:8px;">
          </label>
          <select id="payment">
            <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
            <option value="qr">QR (–æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫–∞–Ω)</option>
          </select>
          <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
          <button type="submit" class="order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
          <div id="orderSuccess" class="order-success" style="display:none;"></div>
        </form>
      </div>
    `;
    modalBg.style.display = 'flex';
    const orderForm = document.getElementById('orderForm');
    if (orderForm) orderForm.onsubmit = sendOrder;
    setTimeout(() => {
      const modal = document.querySelector('.cart-modal');
      if (modal) modal.scrollIntoView({behavior: "smooth", block: "start"});
    }, 50);
  }

  window.closeCartModal = function() {
    document.getElementById('cartModalBg').style.display = 'none';
  };

  async function sendOrder(e) {
    e.preventDefault();
    const btn = document.querySelector('.order-btn');
    btn.disabled = true;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const payment = document.getElementById('payment').value;
    const comment = document.getElementById('comment').value.trim();
    const utensils = Number(document.getElementById('utensils').value) || 0;
    if (!name || !phone || !address) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
      btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return;
    }
    const itemsArr = Object.values(cart);
    if (itemsArr.length === 0) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
    const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty,0);
    let orderLines = itemsArr.map(i=>{
      const g = i.garnish ? ` (${i.garnish})` : '';
      return `${i.name}${g} x${i.qty} ‚Äî ${VND_FMT.format(i.price * i.qty)}`;
    }).join('\n');
    let paymentText = payment==='cash' ? '–û–ø–ª–∞—Ç–∞: –ù–∞–ª–∏—á–Ω—ã–µ' : payment==='qr' ? '–û–ø–ª–∞—Ç–∞: QR' : '';
    const utensilsText = utensils > 0 ? `–°—Ç–æ–ª–æ–≤—ã–µ –ø—Ä–∏–±–æ—Ä—ã: ${utensils}\n` : '';
    const text =
      `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (–°–í–û–Ø –ö–£–•–ù–Ø)\n` +
      `–ù–∏–∫/–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n` +
      utensilsText +
      (paymentText?paymentText+'\n':'') +
      (comment?`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n`:'') +
      `\n–ó–∞–∫–∞–∑:\n${orderLines}\n\n–°—É–º–º–∞: ${VND_FMT.format(total)}`;
    try {
      const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
      });
      const result = await response.json();
      if (result && result.ok) {
        btn.style.display = 'none';
        document.getElementById('orderSuccess').style.display = 'block';
        document.getElementById('orderSuccess').textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.';
        cart = {};
        updateCartFab();
        setTimeout(()=>{ closeCartModal(); renderMenu(); }, 1500);
      } else {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
        console.error('telegram sendMessage failed', result);
      }
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      console.error('sendOrder error', err);
    }
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  loadMenu();
</script>
