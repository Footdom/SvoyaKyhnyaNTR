<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-olive:#556B2F;
      --brand-olive-light:#7B8A2F;
      --bg-cream:#f7efe0;
      --accent:#b3611f;
      --muted:#7c6a5c;
      --card-border:#6b7a29;
    }
    html,body { height:100%; }
    body {
      background: var(--bg-cream);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      margin:0;
      min-height:100vh;
      color:#2b2b2b;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    /* ... –æ—Å–Ω–æ–≤–Ω–æ–π CSS ... (–æ—Å—Ç–∞–≤—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏) ... */

    /* ADDITIONAL MOBILE IMPROVEMENTS */
    @media (max-width: 600px) {
      .header-title { font-size:1.2em; }
      .cart-modal { min-width: 96vw !important; padding:10px 2vw 8px 2vw !important; border-radius:12px !important; }
      .cart-title { font-size: 1em !important; }
      .cart-list li { font-size:1em !important; }
      .product { max-width:96vw !important; width:100%; padding:6px 3vw !important; }
      .product-img { width:58px; height:58px; }
      .cart-fab { width:48px; height:48px; bottom:10px; right:6px; }
      .cart-fab-count { min-width:16px; height:16px; font-size:0.95em; right:0; top:0; }
      .order-form input, .order-form textarea, .order-form select { font-size:1em; }
      .success-logo { width:41px; height:41px; }
      .check-svg { width:68px;height:68px;}
    }
    @media (max-width:399px) {
      .header-title { font-size:0.97em; }
      .product-img { width:46px; height:46px;}
    }
    /* Ensure modal disables background scrolling on mobile */
    body.modal-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100vw;
    }
    /* clickable area for touch targets */
    .add-btn, .remove-btn {
      min-width: 40px;
      min-height: 40px;
      font-size:1.18em;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-wrap">
      <img class="logo-img" src="logo.png" alt="–°–í–û–Ø –ö–£–•–ù–Ø">
      <div>
        <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
        <div class="header-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã ‚Äî –≤–∫—É—Å–Ω–æ, –±—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º</div>
      </div>
    </div>
    <div class="promo-banner">
      <span class="promo-star">‚òÖ</span>
      <span class="promo-text">–ú–ï–ù–Æ</span>
      <span class="promo-star">‚òÖ</span>
    </div>
  </div>

  <!-- loader overlay with logo -->
  <div id="menuLoader" aria-hidden="true">
    <div class="loader-box" role="status" aria-live="polite">
      <img src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="loader-logo" />
      <div class="spinner" aria-hidden="true"></div>
      <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é‚Ä¶</div>
    </div>
  </div>

  <div class="menu" id="menu"></div>

  <button id="cartFab" class="cart-fab" style="display:none;" title="–ö–æ—Ä–∑–∏–Ω–∞" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
    <svg viewBox="0 0 48 48" width="56" height="56" style="display:block;margin:auto;">
      <circle cx="24" cy="24" r="22" class="cart-fab-circle"/>
      <path d="M16 18h16l-2 13a3 3 0 0 1-3 2h-6a3 3 0 0 1-3-2l-2-13zm3 0v-4a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v4" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
      <circle cx="19" cy="36" r="2" fill="#fff"/>
      <circle cx="29" cy="36" r="2" fill="#fff"/>
    </svg>
    <span id="cartFabCount" class="cart-fab-count" aria-hidden="true"></span>
  </button>

  <div id="cartModalBg" class="cart-modal-bg" style="display:none;"></div>

  <script>
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    const SHEET_API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';
    const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

    // –ù–ï —Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –∫–ª–∏–µ–Ω—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ Apps Script / —Å–µ—Ä–≤–µ—Ä
    const TELEGRAM_BOT_TOKEN = '8543195311:AAGzpZwTaUAgw3qp6AeKQA_BbFX35jtbJIk';
    const TELEGRAM_CHAT_ID = '7567253745';

    let menuData = [];
    let cart = {};

    // –í–∞–ª—é—Ç–∞ ‚Äî –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π –¥–æ–Ω–≥
    const VND_FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    function toNumberSafe(v) {
      if (typeof v === 'number') return v;
      if (v == null) return 0;
      let s = String(v).replace(/\u00A0/g, '').trim();
      s = s.replace(/[^\d,.\-]/g, '');
      if (!s) return 0;
      s = s.replace(/,/g, '.');
      const parts = s.split('.');
      if (parts.length > 2) {
        const frac = parts.pop();
        s = parts.join('') + '.' + frac;
      }
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    function showLoader(){ const l=document.getElementById('menuLoader'); if(!l) return; l.classList.add('visible'); l.setAttribute('aria-hidden','false'); }
    function hideLoader(){ const l=document.getElementById('menuLoader'); if(!l) return; l.classList.remove('visible'); l.setAttribute('aria-hidden','true'); }

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    let orderInProcess = false;

    // –ë–ª–æ–∫–∏—Ä—É–µ—Ç background scroll –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –º–æ–¥–∞–ª–∫–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –º–æ–±–∏–ª–∫–µ)
    function setModalOpen(open) {
      if(open) document.body.classList.add('modal-open');
      else document.body.classList.remove('modal-open');
    }

    async function loadMenu() {
      showLoader();
      const safetyTimeout = setTimeout(()=>{ hideLoader(); }, 20000);
      try {
        const res = await fetch(SHEET_API_URL);
        if (!res.ok) throw new Error('Primary sheet fetch failed: ' + res.status);
        const json = await res.json();

        if (json && Array.isArray(json.values) && json.values.length > 0) {
          const rows = json.values;
          const headers = rows[0].map(h => String(h || '').trim().toLowerCase());
          const dataRows = rows.slice(1);
          menuData = dataRows.map((row, idx) => {
            const obj = {};
            headers.forEach((h, i) => obj[h] = row[i] !== undefined ? row[i] : '');
            return {
              id: idx + 1,
              name: obj.name || obj.title || `–ë–ª—é–¥–æ ${idx+1}`,
              description: obj.description || obj.desc || '',
              img: obj.img || obj.image || '',
              price: toNumberSafe(obj.price || obj.cost || obj['—Ü–µ–Ω–∞']),
              available: String(obj.available || obj.–¥–æ—Å—Ç—É–ø–Ω–æ || 'true').trim().toLowerCase() === 'true'
            };
          });
          clearTimeout(safetyTimeout);
          hideLoader();
          renderMenu();
          return;
        }

        if (json && json.menu && Array.isArray(json.menu)) {
          menuData = json.menu.map((item, idx) => ({
            id: idx + 1,
            name: item.name || item.title || `–ë–ª—é–¥–æ ${idx+1}`,
            description: item.description || item.desc || '',
            img: item.img || item.image || '',
            price: toNumberSafe(item.price),
            available: String(item.available).trim().toLowerCase() === 'true'
          }));
          clearTimeout(safetyTimeout);
          hideLoader();
          renderMenu();
          return;
        }

        if (Array.isArray(json) && json.length > 0 && typeof json[0] === 'object') {
          menuData = json.map((item, idx) => ({
            id: idx + 1,
            name: item.name || item.title || `–ë–ª—é–¥–æ ${idx+1}`,
            description: item.description || item.desc || '',
            img: item.img || item.image || '',
            price: toNumberSafe(item.price),
            available: String(item.available).trim().toLowerCase() === 'true'
          }));
          clearTimeout(safetyTimeout);
          hideLoader();
          renderMenu();
          return;
        }

        throw new Error('Unknown sheet response format');
      } catch (err) {
        console.warn('Primary load failed, trying fallback...', err);
        try {
          const res2 = await fetch(SHEET_API_FALLBACK);
          if (!res2.ok) throw new Error('Fallback fetch failed: ' + res2.status);
          const j2 = await res2.json();
          if (j2 && j2.menu && Array.isArray(j2.menu)) {
            menuData = j2.menu.map((item, idx) => ({
              id: idx + 1,
              name: item.name || item.title || `–ë–ª—é–¥–æ ${idx+1}`,
              description: item.description || item.desc || '',
              img: item.img || item.image || '',
              price: toNumberSafe(item.price),
              available: String(item.available).trim().toLowerCase() === 'true'
            }));
            clearTimeout(safetyTimeout);
            hideLoader();
            renderMenu();
            return;
          }
          throw new Error('Fallback returned unexpected format');
        } catch (e) {
          clearTimeout(safetyTimeout);
          hideLoader();
          document.getElementById('menu').innerHTML = '<div style="color:var(--brand-olive);font-size:1.1em;text-align:center;margin:40px auto;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
        }
      }
    }

    function renderMenu() {
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      if (!menuData || menuData.length === 0) {
        menu.innerHTML = '<div style="color:var(--brand-olive);font-size:1.05em;text-align:center;margin:40px auto;">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</div>';
        updateCartFab();
        return;
      }
      menuData.forEach(item => {
        const prod = document.createElement('div');
        prod.className = 'product' + (!item.available ? ' unavailable' : '');
        const priceText = VND_FMT.format(Number(item.price) || 0); // —Ñ–æ—Ä–º–∞—Ç ‚Äî –¥–æ–Ω–≥–∏
        prod.innerHTML = `
          ${!item.available ? `<div class="prod-unavailable">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>` : ''}
          <img class="product-img" src="${item.img || 'https://via.placeholder.com/100x100?text=–§–æ—Ç–æ'}" alt="${escapeHtml(item.name)}">
          <div class="product-name">${escapeHtml(item.name)}</div>
          <div class="product-desc">${escapeHtml(item.description || '')}</div>
          <div class="product-price">${priceText}</div>
          <div class="controls">
            <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
            <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
            <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
          </div>
        `;
        menu.appendChild(prod);
      });
      updateCartFab();
    }

    window.updateCart = function(id, delta) {
      const item = menuData.find(i=>i.id===id);
      if (!item || !item.available) return;
      if (!cart[id]) cart[id] = { ...item, qty: 0 };
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      const qtyEl = document.getElementById(`qty-${id}`);
      if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
      updateCartFab();
      if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
    };

    function updateCartFab() {
      const fab = document.getElementById('cartFab');
      const count = Object.values(cart).reduce((s,i)=>s + (i.qty || 0), 0);
      if (count > 0) {
        fab.style.display = 'flex';
        document.getElementById('cartFabCount').textContent = count;
      } else {
        fab.style.display = 'none';
        document.getElementById('cartFabCount').textContent = '';
      }
    }

    document.getElementById('cartFab').onclick = showCartModal;

    function showCartModal() {
      setModalOpen(true);
      const modalBg = document.getElementById('cartModalBg');
      const items = Object.values(cart);
      const listHtml = items.length === 0
        ? '<li style="color:var(--brand-olive);text-align:center;width:100%;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</li>'
        : items.map(it => `
            <li>
              <span>${escapeHtml(it.name)} x${it.qty}</span>
              <span>
                <button class="remove-btn" onclick="updateCart(${it.id},-1)">‚àí</button>
                <span style="margin:0 8px;">${VND_FMT.format((it.price||0) * it.qty)}</span>
                <button class="add-btn" onclick="updateCart(${it.id},1)">+</button>
              </span>
            </li>
          `).join('');
      const total = items.reduce((s,i)=>s + (i.price || 0) * i.qty, 0);
      modalBg.innerHTML = `
        <div class="cart-modal" role="dialog" aria-modal="true" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
          <button class="cart-close" onclick="closeCartModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="position:absolute;right:10px;top:6px;border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
          <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <ul class="cart-list">${listHtml}</ul>
          <div class="cart-total">–ò—Ç–æ–≥–æ: ${VND_FMT.format(total)}</div>
          <form class="order-form" id="orderForm">
            <input type="text" id="nickname" placeholder="–¢–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º –≤ Telegram" required pattern="^@[A-Za-z0-9_]{5,}$" title="–£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º Telegram, –Ω–∞—á–∏–Ω–∞—è —Å @, –Ω–∞–ø—Ä–∏–º–µ—Ä: @username">
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
            <select id="payment">
              <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
              <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
              <option value="qr">QR (–æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫–∞–Ω)</option>
            </select>
            <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            <button type="submit" class="order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="orderSuccess" class="order-success" style="display:none;"></div>
          </form>
        </div>
      `;
      modalBg.style.display = 'flex';
      const orderForm = document.getElementById('orderForm');
      if (orderForm) orderForm.onsubmit = sendOrder;
      setTimeout(() => {
        const modal = document.querySelector('.cart-modal');
        if (modal) modal.scrollIntoView({behavior: "smooth", block: "start"});
      }, 50);
    }

    window.closeCartModal = function() {
      setModalOpen(false);
      document.getElementById('cartModalBg').style.display = 'none';
    };

    // show animated success overlay inside modal
    function showOrderSuccessAnimation(message){
      const modal = document.querySelector('.cart-modal');
      if (!modal) return;
      // remove existing overlay if any
      const prev = modal.querySelector('.order-success-overlay');
      if (prev) prev.remove();

      const overlay = document.createElement('div');
      overlay.className = 'order-success-overlay';
      overlay.innerHTML = `
        <img src="logo.png" alt="logo" class="success-logo" />
        <svg class="check-svg" viewBox="0 0 120 120" aria-hidden="true">
          <circle class="circle" cx="60" cy="60" r="52"></circle>
          <path class="check" d="M34 63l18 16 34-38"></path>
        </svg>
        <div class="success-text">${escapeHtml(message || '–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç.')}</div>
      `;
      modal.appendChild(overlay);
      // trigger visible
      setTimeout(()=> overlay.classList.add('visible'), 10);
      // auto close after short delay
      setTimeout(()=>{
        overlay.classList.remove('visible');
        setTimeout(()=> { overlay.remove(); closeCartModal(); renderMenu(); }, 220);
      }, 1700);
    }

    async function sendOrder(e) {
      e.preventDefault();
      if(orderInProcess) return;
      orderInProcess = true;
      const btn = document.querySelector('.order-btn');
      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      const nickname = document.getElementById('nickname').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.getElementById('payment').value;
      const comment = document.getElementById('comment').value.trim();
      if (!nickname || !phone || !address) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; orderInProcess=false; return;
      }
      if (!/^@[A-Za-z0-9_]{5,}$/.test(nickname)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram-–Ω–∏–∫–Ω–µ–π–º (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @, –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤)!');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; orderInProcess=false; return;
      }
      const itemsArr = Object.values(cart);
      if (itemsArr.length === 0) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; orderInProcess=false; return; }
      const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty,0);
      let orderLines = itemsArr.map(i=>`${i.name} x${i.qty} ‚Äî ${VND_FMT.format(i.price * i.qty)}`).join('\n');
      let paymentText = payment==='cash' ? '–û–ø–ª–∞—Ç–∞: –ù–∞–ª–∏—á–Ω—ã–µ' : payment==='qr' ? '–û–ø–ª–∞—Ç–∞: QR' : '';
      const text =
        `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (–°–í–û–Ø –ö–£–•–ù–Ø)\n` +
        `Telegram: ${nickname}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n` +
        (paymentText?paymentText+'\n':'') +
        (comment?`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n`:'') +
        `\n–ó–∞–∫–∞–∑:\n${orderLines}\n\n–°—É–º–º–∞: ${VND_FMT.format(total)}`;
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
        });
        const result = await response.json();
        if (result && result.ok) {
          cart = {};
          updateCartFab();
          showOrderSuccessAnimation('–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.');
          btn.style.display = 'none';
        } else {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      }
      orderInProcess = false;
    }

    // init
    loadMenu();
  </script>
</body>
</html>
